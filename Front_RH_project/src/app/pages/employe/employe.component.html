<div class="container mt-4">
  

  <!-- HEADER                     -->

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Employee Management</h2>
    <button class="btn btn-primary btn-add" (click)="openModal()">
      + Add New
    </button>
  </div>


  <!-- 1. FILTER SECTION          -->

  <div class="filter-card">
    <div class="filter-header">
      <h3>üöÄ Advanced Filter</h3>
      <p>Find employees by Region and Department</p>
    </div>

    <div class="filter-body">
      <div class="row">
        
        <div class="col-md-6 mb-3">
          <label class="filter-label">Select Region</label>
          <select class="form-control filter-select" 
                  [(ngModel)]="selectedRegionId" 
                  (change)="onRegionChange()">
            <option [ngValue]="null">-- Choose a Region --</option>
            <option *ngFor="let r of regions" [ngValue]="r.id">
              üåç {{ r.name }}
            </option>
          </select>
        </div>

      
        <div class="col-md-6 mb-3">
          <label class="filter-label">Select Department</label>
          <select class="form-control filter-select" 
                  [(ngModel)]="selectedDeptId" 
                  (change)="onDeptChange()"
                  [disabled]="!selectedRegionId">
            <option [ngValue]="null">-- Choose a Department --</option>
          
            <option *ngFor="let d of filteredDepartments" [ngValue]="d.id">
              üè¢ {{ d.name }}
            </option>
          </select>
        </div>

      </div>
    </div>

    <!-- FILTER RESULTS TABLE -->
    <div class="filter-results" *ngIf="selectedDeptId">
      <h4 class="results-title">Found {{ filteredEmployeesList.length }} Employees</h4>
      
      <div class="table-container" *ngIf="filteredEmployeesList.length > 0">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Salary</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let emp of filteredEmployeesList">
              <td>#{{ emp.id }}</td>
              <td>{{ emp.FIRST_NAME }} {{ emp.LAST_NAME }}</td>
              <td>${{ emp.SALARY }}</td>
              <td class="text-center action-buttons">
                <button class="btn-icon view" (click)="openViewModal(emp)"></button>
              </td>
            </tr>
          </tbody>
        </table>
        <button class="btn btn-export" (click)="exportFilteredReport()">
        üìÑ Export filtred Data
      </button>
      </div>
      
      <div class="no-results" *ngIf="filteredEmployeesList.length === 0">
        <p>No employees found in this department.</p>
      </div>
    </div>
  </div>

  <!-- 2. SEARCH SECTION          -->
 
  <div class="table-header-row">
    <div class="filter-header">
      <h3>ALL EMPLOYEES</h3>
    </div>
    <div class="search-container">
      <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" placeholder="Search ID..."
               [(ngModel)]="searchId" (input)="searchEmployeeById()" name="searchId">
        <button class="btn-clear" *ngIf="searchId" (click)="clearSearch()">‚úï</button>
      </div>
    </div>
        <button class="btn btn-export" (click)="exportReport()">
        üìÑ Export All Data
      </button>
      <button class="btn btn-export" (click)="exportAttestation()" style="margin-left: 60%; ">
        üìÑ get attestation
      </button>
  </div>

  <!-- SEARCH RESULT CARD -->
  <div class="employee-detail-card" *ngIf="searchId && filteredEmployees.length === 1">
    <div class="detail-card-header">
      <div class="detail-avatar"></div>
      <div class="detail-info">
        <h3 class="detail-name">{{ filteredEmployees[0].FIRST_NAME }} {{ filteredEmployees[0].LAST_NAME }}</h3>
        <p class="detail-id">Employee ID: #{{ filteredEmployees[0].id }}</p>
      </div>
    </div>
    <div class="detail-card-body">
      <div class="detail-field highlight">
        <div class="detail-label">Salary</div>
        <div class="detail-value">${{ filteredEmployees[0].SALARY }}</div>
      </div>
      <div class="detail-field">
        <div class="detail-label">Department</div>
        <div class="detail-value">{{ filteredEmployees[0].dept_name || 'Unassigned' }}</div>
      </div>
      <div class="detail-field">
        <div class="detail-label">Region</div>
        <div class="detail-value">{{ filteredEmployees[0].region_name || 'Unassigned' }}</div>
      </div>
    </div>
    <div class="detail-card-actions">
      <button class="btn-icon edit" (click)="editEmployee(filteredEmployees[0])">Edit</button>
      <button class="btn-icon delete" (click)="deleteEmployee(filteredEmployees[0].id)">Delete</button>
    </div>
  </div>


  <!-- 3. MAIN TABLE              -->
 
  <div class="table-container">
    <table class="table">
      <thead>
  <tr>
    <th class="sortable" (click)="sortData('id')">
      ID <span>{{ getSortIcon('id') }}</span>
    </th>
    <th class="sortable" (click)="sortData('FIRST_NAME')">
      First Name <span>{{ getSortIcon('FIRST_NAME') }}</span>
    </th>
    <th class="sortable" (click)="sortData('LAST_NAME')">
      Last Name <span>{{ getSortIcon('LAST_NAME') }}</span>
    </th>
    <th class="sortable" (click)="sortData('dept_name')">
      Department <span>{{ getSortIcon('dept_name') }}</span>
    </th>
    <th class="text-center">Actions</th>
  </tr>
</thead>
      <tbody>
        <tr *ngFor="let emp of employees">
          <td>#{{ emp.id }}</td>
          <td>{{ emp.FIRST_NAME }}</td>
          <td>{{ emp.LAST_NAME   }}</td>
          <td><span class="badge-dept">{{ emp.dept_name || 'Unassigned' }}</span></td>
          <td class="text-center action-buttons">
            <button class="btn-icon view" (click)="openViewModal(emp)" title="View"></button>
            <button class="btn-icon edit" (click)="editEmployee(emp)" title="Edit"></button>
            <button class="btn-icon delete" (click)="deleteEmployee(emp.id)" title="Delete"></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>


  <!-- MODAL 1: ADD/EDIT FORM     -->
 
  <div class="modal-overlay" *ngIf="isModalOpen">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ form.id ? 'Update Employee' : 'Add Employee' }}</h3>
        <span class="close-btn" (click)="closeModal()">&times;</span>
      </div>
      <div class="modal-body">
       
<form #empForm="ngForm">
  <div class="row">
    
  
    <div class="col-md-6 mb-3">
      <label>First Name</label>
      <input 
        type="text" 
        class="form-control" 
        [(ngModel)]="form.FIRST_NAME" 
        name="firstName" 
        required 
        #fname="ngModel"
        [class.is-invalid]="fname.invalid && fname.touched"
      >
  
      <div class="error-msg" *ngIf="fname.invalid && fname.touched" style="color: rgb(212, 71, 71);">
        First name is required.
      </div>
    </div>


    <div class="col-md-6 mb-3">
      <label>Last Name </label>
      <input 
        type="text" 
        class="form-control" 
        [(ngModel)]="form.LAST_NAME" 
        name="lastName" 
        required 
        #lname="ngModel"
        [class.is-invalid]="lname.invalid && lname.touched"
      >
      <div class="error-msg" *ngIf="lname.invalid && lname.touched" style="color: rgb(212, 71, 71);">
        Last name is required.
      </div>
    </div>

    
    <div class="col-md-6 mb-3">
      <label>Salary </label>
      <input 
        type="number" 
        class="form-control" 
        [(ngModel)]="form.SALARY" 
        name="salary" 
        required 
        min="1" 
        #sal="ngModel"
        [class.is-invalid]="sal.invalid && sal.touched"
      >
      <div class="error-msg" *ngIf="sal.invalid && sal.touched" style="color: rgb(212, 71, 71);">
        <span *ngIf="sal.errors?.['required']">Salary is required.</span>
        <span *ngIf="sal.errors?.['min']">Salary must be greater than 0.</span>
      </div>
    </div>

   

    <div class="col-md-6 mb-3">
      <label>Region </label>
      <select class="form-control" 
              [(ngModel)]="modalSelectedRegionId" 
              (change)="onModalRegionChange()" 
              name="modalRegion" 
              required>
        <option [ngValue]="null" disabled>Select Region</option>
        <option *ngFor="let r of regions" [ngValue]="r.id">üåç {{ r.name }}</option>
      </select>
    </div>

    <div class="col-md-6 mb-3">
      <label>Department </label>
      <select class="form-control" 
              [(ngModel)]="form.dept_id" 
              name="dept_id" 
              required
              [disabled]="!modalSelectedRegionId">
        <option [ngValue]="null" disabled>Select Dept</option>
        <option *ngFor="let d of modalFilteredDepts" [ngValue]="d.id">üè¢ {{ d.name }}</option>
      </select>
    </div>

  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
    
    
    <button 
      type="button" 
      class="btn btn-primary" 
      (click)="saveEmployee()" 
      [disabled]="empForm.invalid">
      {{ form.id ? 'Save Changes' : 'Create' }}
    </button>
  </div>
</form>
      </div>
    </div>
  </div>

  <!-- MODAL 2: VIEW DETAILS      -->
 
  <div class="modal-overlay" *ngIf="isViewModalOpen">
    <div class="modal-content view-card">
      <div class="modal-header">
        <h3>Employee Profile</h3>
        <span class="close-btn" (click)="closeViewModal()">&times;</span>
      </div>
      <div class="modal-body text-center" *ngIf="selectedEmployee">
        <div class="profile-avatar"></div>
        <h4 class="emp-name">{{ selectedEmployee.FIRST_NAME }} {{ selectedEmployee.LAST_NAME }}</h4>
        <p class="emp-id">ID: #{{ selectedEmployee.id  }}</p>
        <hr class="divider">
        <div class="details-grid">
          <div class="detail-item highlight">
            <span class="label"> Salary</span>
            <span class="value salary-text">${{ selectedEmployee.SALARY }}</span>
          </div>
          <div class="detail-item">
            <span class="label"> Department</span>
            <span class="value">{{ selectedEmployee.dept_name || 'Unassigned' }}</span>
          </div>
          <div class="detail-item">
            <span class="label"> Region</span>
            <span class="value">{{ selectedEmployee.region_name || 'Unassigned' }}</span>
          </div>
        </div>
      </div>
      <button class="btn btn-export" (click)="exportAttestation()" style="margin-left: 60%; ">
        üìÑ get attestation
      </button>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-primary" (click)="closeViewModal()">Close</button>
      </div>
    </div>
  </div>


<!-- TOAST NOTIFICATION CONTAINER -->
<div class="toast-container" [class.show]="showToast" [class.error]="toastType === 'error'">
  <div class="toast-icon">
    {{ toastType === 'success' ? '‚úÖ' : '‚ùå' }}
  </div>
  <div class="toast-body">
    <h4 class="toast-title">{{ toastType === 'success' ? 'Success' : 'Error' }}</h4>
    <p class="toast-message">{{ toastMessage }}</p>
  </div>
  <button class="toast-close" (click)="showToast = false">‚úï</button>
</div>
</div>
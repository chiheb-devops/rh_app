<div class="container mt-4">
  
  <!-- ========================== -->
  <!-- HEADER                     -->
  <!-- ========================== -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Department Management</h2>
    <button class="btn btn-primary btn-add" (click)="openModal()">
      + Add New
    </button>
  </div>

  <!-- ========================== -->
  <!-- SEARCH SECTION             -->
  <!-- ========================== -->
  <div class="search-container">
    <div class="search-wrapper">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        class="search-input" 
        placeholder="Search by Dept ID (e.g., 1, 2...)"
        [(ngModel)]="searchId"
        (input)="searchDeptById()"
        name="searchId"
      >
      <button 
        class="btn-clear" 
        *ngIf="searchId" 
        (click)="clearSearch()"
        title="Clear search"
      >‚úï</button>
    </div>
  </div>

  <!-- SEARCH RESULT CARD -->
  <div class="employee-detail-card" *ngIf="foundDept">
    <div class="detail-card-header">
      <div class="detail-avatar profile-avatar"></div>
      <div class="detail-info">
        <h3 class="detail-name">{{ foundDept.name }}</h3>
        <p class="detail-id">Dept ID: #{{ foundDept.id }}</p>
      </div>
    </div>

    <div class="detail-card-body">
      <div class="detail-field highlight">
        <div class="detail-label">Region</div>
        <div class="detail-value">{{ foundDept.region_name || 'Unassigned' }}</div>
      </div>
      <div class="detail-field">
        <div class="detail-label">Employees</div>
        <div class="detail-value">{{ foundDept.emp_count }} Members</div>
      </div>
    </div>
 
    <div class="detail-card-actions">
      <button class="btn-icon view" (click)="openViewModal(foundDept)">View Details</button>
      <button class="btn-icon edit" (click)="editDept(foundDept)">Edit Dept</button>
      <button class="btn-icon delete" (click)="deleteDept(foundDept.id)">Delete Dept</button>
    </div>
  </div>

  <!-- ========================== -->
  <!-- TABLE SECTION              -->
  <!-- ========================== -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th class="sortable" (click)="sortData('id')">
            ID <span>{{ getSortIcon('id') }}</span>
          </th>
          <th class="sortable" (click)="sortData('name')">
            Department Name <span>{{ getSortIcon('name') }}</span>
          </th>
          <th class="sortable" (click)="sortData('region_name')">
            Region <span>{{ getSortIcon('region_name') }}</span>
          </th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of departments">
          <td>#{{ d.id }}</td>
          <td>{{ d.name }}</td>
          <td>
            <span class="badge-dept">{{ d.region_name || 'Unassigned' }}</span>
          </td>
          
          <td class="text-center action-buttons">
            <button class="btn-icon view" (click)="openViewModal(d)" title="View Details"></button>
            <button class="btn-icon edit" (click)="editDept(d)" title="Edit"></button>
            <button class="btn-icon delete" (click)="deleteDept(d.id)" title="Delete"></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ========================== -->
  <!-- MODAL 1: ADD/EDIT FORM     -->
  <!-- ========================== -->
  <div class="modal-overlay" *ngIf="isModalOpen">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ form.id ? 'Update Department' : 'Add Department' }}</h3>
        <span class="close-btn" (click)="closeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label>Department Name</label>
              <input type="text" class="form-control" [(ngModel)]="form.name" name="name" placeholder="e.g. Human Resources">
            </div>

            <div class="col-md-12 mb-3">
              <label>Region</label>
              <select class="form-control" [(ngModel)]="form.region_id" name="region_id">
                <option [ngValue]="null" disabled>Select Region</option>
                <option *ngFor="let r of regions" [ngValue]="r.id">{{ r.name }}</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="saveDept()">
              {{ form.id ? 'Save Changes' : 'Create' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ========================== -->
  <!-- MODAL 2: VIEW DETAILS      -->
  <!-- ========================== -->
  <div class="modal-overlay" *ngIf="isViewModalOpen">
    <div class="modal-content view-card">
      <div class="modal-header">
        <h3>Department Details</h3>
        <span class="close-btn" (click)="closeViewModal()">&times;</span>
      </div>
      
      <div class="modal-body text-center" *ngIf="selectedDept">
        
        <!-- Department Icon -->
        <div class="profile-avatar"></div>

        <h4 class="emp-name">{{ selectedDept.name }}</h4>
        <p class="emp-id">Dept ID: #{{ selectedDept.id }}</p>

        <hr class="divider">

        <div class="details-grid">
          
          <!-- Region Row -->
          <div class="detail-item highlight">
            <span class="label">üåç Region</span>
            <span class="value salary-text">{{ selectedDept.region_name || 'Unassigned' }}</span>
          </div>

          <!-- Employees Count Row (Clickable) -->
          <div class="detail-item clickable-item" (click)="toggleEmpList()" 
               [class.has-items]="selectedDept.emp_count > 0">
            <span class="label">üë• Employees</span>
            <span class="value">
              {{ selectedDept.emp_count }}
              <span class="small-hint" *ngIf="selectedDept.emp_count > 0">
                (Click to {{ showEmpList ? 'hide' : 'view' }})
              </span>
            </span>
          </div>

          <!-- Hidden List (Shows when clicked) -->
          <div class="emp-list-container" *ngIf="showEmpList">
            <h5 class="list-title">Team Members:</h5>
            <ul class="emp-list">
              <li *ngFor="let emp of selectedDept.emp_list" 
                  (click)="openEmployeeDetail(emp.id)" 
                  class="clickable-emp">
                {{ emp.name }}
              </li>
            </ul>
          </div>

        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-primary" (click)="closeViewModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODAL 3: EMPLOYEE DETAIL (Second Layer)    -->
  <!-- ========================================== -->
  <div class="modal-overlay second-layer" *ngIf="isEmpDetailModalOpen">
    <div class="modal-content view-card">
      <div class="modal-header">
        <h3>Employee Profile</h3>
        <span class="close-btn" (click)="closeEmployeeDetail()">&times;</span>
      </div>
      
      <div class="modal-body text-center" *ngIf="selectedEmployee">
        
        <!-- Avatar -->
        <div class="profile-avatar emp-avatar"></div>

        <!-- Name & ID -->
        <h4 class="emp-name">
          {{ selectedEmployee.firstName }} {{ selectedEmployee.lastName }}
        </h4>
        <p class="emp-id">ID: #{{ selectedEmployee.id }}</p>

        <hr class="divider">

        <!-- Details -->
        <div class="details-grid">
          <div class="detail-item highlight">
            <span class="label">üí∞ Salary</span>
            <span class="value salary-text">${{ selectedEmployee.salary }}</span>
          </div>

          <div class="detail-item">
            <span class="label">üè¢ Department</span>
            <span class="value">{{ selectedEmployee.dept_name || 'Unassigned' }}</span>
          </div>
        </div>

      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-primary" (click)="closeEmployeeDetail()">Close</button>
      </div>
    </div>
  </div>

  <!-- ========================== -->
  <!-- TOAST NOTIFICATION         -->
  <!-- ========================== -->
  <div class="toast-container" [class.show]="showToast" [class.error]="toastType === 'error'">
    <div class="toast-icon">
      {{ toastType === 'success' ? '‚úÖ' : '‚ùå' }}
    </div>
    <div class="toast-body">
      <h4 class="toast-title">{{ toastType === 'success' ? 'Success' : 'Error' }}</h4>
      <p class="toast-message">{{ toastMessage }}</p>
    </div>
    <button class="toast-close" (click)="showToast = false">‚úï</button>
  </div>

</div>